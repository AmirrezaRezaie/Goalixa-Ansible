- name: Verify app source exists on control machine
  ansible.builtin.stat:
    path: "{{ app_src }}"
  register: app_src_stat
  delegate_to: localhost
  become: false
  run_once: true

- name: Fail if app source path is missing
  ansible.builtin.fail:
    msg: "app_src does not exist on control machine: {{ app_src }}"
  when: not app_src_stat.stat.exists

- name: Ensure app destination exists on target
  ansible.builtin.file:
    path: "{{ app_dest }}"
    state: directory
    mode: "0755"

- name: Ensure rsync is installed on target
  ansible.builtin.package:
    name: rsync
    state: present
  when: app_sync_method == "rsync"

- name: Sync app sources to target with rsync
  ansible.builtin.synchronize:
    src: "{{ app_src }}/"
    dest: "{{ app_dest }}/"
    delete: "{{ app_sync_delete }}"
    rsync_opts: "{{ app_sync_excludes | map('regex_replace', '^(.*)$', '--exclude=\\1') | list }}"
  when: app_sync_method == "rsync"

- name: Sync app sources to target with copy
  ansible.builtin.copy:
    src: "{{ app_src }}/"
    dest: "{{ app_dest }}/"
    owner: root
    group: root
    mode: "0644"
    directory_mode: "0755"
  when: app_sync_method != "rsync"

- name: Pull images (optional)
  ansible.builtin.command:
    cmd: >-
      docker compose
      -f {{ compose_file }}
      {% if compose_project_name %}--project-name {{ compose_project_name }}{% endif %}
      pull
    chdir: "{{ app_dest }}"
  when: compose_pull

- name: Build and start services
  ansible.builtin.command:
    cmd: >-
      docker compose
      -f {{ compose_file }}
      {% if compose_project_name %}--project-name {{ compose_project_name }}{% endif %}
      up {{ compose_up_args }}{% if compose_build %} --build{% endif %}
    chdir: "{{ app_dest }}"
